<!doctype html>
<html lang=en>
<head>
    <title>twebo</title>
    <meta charset=utf-8>
    <meta name=viewport content="width=device-width, initial-scale=1">

    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css" integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="style.css"/>
</head>

<body id="body">
<!--
    <div id="content">
        <div id="presence-pane"  class="presence-pane">
            <div class="presence-group">
                <div class="presence-status presence-active">&bull;</div>
                <div class="presence-user">bill</div>
            </div>
            <div class="presence-group">
                <div class="presence-status presence-active">&bull;</div>
                <div class="presence-user">d</div>
            </div>
            <div class="presence-group">
                <div class="presence-status presence-idle">&bull;</div>
                <div class="presence-user">ted</div>
            </div>
            <div class="presence-group">
                <div class="presence-status presence-offline">&bull;</div>
                <div class="presence-user">longnameexample</div>
            </div>
        </div>

        <div class="presence-control">
            <div id="presence-button">&lt;</div>
        </div>

        <div class="history-pane">
            <div class="message">
                <div class="time">
                    Today, 09:04
                </div>
                <div class="group">
                    Chat
                </div>
                <div class="user">
                    bill
                </div>
                <div class="text">
                    Bored, are we?
                </div>
            </div>

            <div class="message">
                <div class="time">
                    Today, 09:04
                </div>
                <div class="group">
                    Chat
                </div>
                <div class="user">
                    bill
                </div>
                <div class="text">
                    &nbsp;&nbsp;Bored, are we?
                </div>
            </div>

            <div class="message">
                <div class="time">
                    Today, 09:04
                </div>
                <div class="group">
                    Chat
                </div>
                <div class="user">
                    bill
                </div>
                <div class="text">
                    &nbsp;&nbsp;&nbsp;&nbsp;Bored, are we?
                </div>
            </div>

            <div class="message">
                <div class="time">
                    Today, 09:04
                </div>
                <div class="group">
                    Chat
                </div>
                <div class="user">
                    bill
                </div>
                <div class="text">
                    &nbsp;&nbsp;&nbsp;&nbsp;Bored, are we?
                </div>
            </div>

            <div class="message">
                <div class="time">
                    Today, 09:04
                </div>
                <div class="group">
                    Chat
                </div>
                <div class="user">
                    bill
                </div>
                <div class="text">
                    &nbsp;&nbsp;&nbsp;&nbsp;Bored, are we?
                </div>
            </div>

            <div class="message">
                <div class="time">
                    Today, 09:04
                </div>
                <div class="group">
                    Chat
                </div>
                <div class="user">
                    bill
                </div>
                <div class="text">
                    &nbsp;&nbsp;&nbsp;&nbsp;Bored, are we?
                </div>
            </div>

            <div class="message">
                <div class="time">
                    Today, 09:04
                </div>
                <div class="group">
                    Chat
                </div>
                <div class="user">
                    bill
                </div>
                <div class="text">
                    &nbsp;&nbsp;&nbsp;&nbsp;Bored, are we?
                </div>
            </div>

            <div class="message">
                <div class="time">
                    Today, 09:04
                </div>
                <div class="group">
                    Chat
                </div>
                <div class="user">
                    bill
                </div>
                <div class="text">
                    &nbsp;&nbsp;&nbsp;&nbsp;Bored, are we?
                </div>
            </div>

            <div class="message">
                <div class="time">
                    Today, 09:04
                </div>
                <div class="group">
                    Chat
                </div>
                <div class="user">
                    bill
                </div>
                <div class="text">
                    &nbsp;&nbsp;&nbsp;&nbsp;Bored, are we?
                </div>
            </div>

            <div class="message">
                <div class="time">
                    Today, 09:04
                </div>
                <div class="group">
                    Chat
                </div>
                <div class="user">
                    bill
                </div>
                <div class="text">
                    &nbsp;&nbsp;&nbsp;&nbsp;Bored, are we?
                </div>
            </div>

            <div class="message">
                <div class="time">
                    Today, 09:04
                </div>
                <div class="group">
                    Chat
                </div>
                <div class="user">
                    bill
                </div>
                <div class="text">
                    &nbsp;&nbsp;&nbsp;&nbsp;Bored, are we?
                </div>
            </div>

            <div class="message">
                <div class="time">
                    Today, 09:04
                </div>
                <div class="group">
                    Chat
                </div>
                <div class="user">
                    bill
                </div>
                <div class="text">
                    &nbsp;&nbsp;&nbsp;&nbsp;Bored, are we?
                </div>
            </div>

            <div class="message">
                <div class="time">
                    Today, 09:04
                </div>
                <div class="group">
                    Chat
                </div>
                <div class="user">
                    bill
                </div>
                <div class="text">
                    &nbsp;&nbsp;&nbsp;&nbsp;Bored, are we?
                </div>
            </div>

            <div class="message">
                <div class="time">
                    Today, 09:04
                </div>
                <div class="group">
                    Chat
                </div>
                <div class="user">
                    bill
                </div>
                <div class="text">
                    &nbsp;&nbsp;&nbsp;&nbsp;Bored, are we?
                </div>
            </div>

            <div class="message">
                <div class="time">
                    Today, 09:04
                </div>
                <div class="group">
                    Chat
                </div>
                <div class="user">
                    bill
                </div>
                <div class="text">
                    &nbsp;&nbsp;&nbsp;&nbsp;Bored, are we?
                </div>
            </div>

            <div class="message">
                <div class="time">
                    Today, 09:04
                </div>
                <div class="group">
                    Chat
                </div>
                <div class="user">
                    bill
                </div>
                <div class="text">
                    &nbsp;&nbsp;&nbsp;&nbsp;Bored, are we?
                </div>
            </div>
        </div>

        <div class="compose-pane">

            <label class="group-label label" for="group-select">To</label>
            <select id="group-select" class="input">
                <option class="group-option" value="Chat">Chat</option>
                <option class="group-option" value="elvin">elvin</option>
                <option class="group-option" value="lunch">lunch</option>
                <option class="group-option" value="zaphod">zaphod</option>
            </select>

            <label class="from-label label" for="from-text">From</label>
            <input id="from-text" class="input"/>

            <label class="timeout-label label" for="timeout-text">Timeout</label>
            <input id="timeout-text" class="input"/>

            <label class="text-label label" for="text-text">Text</label>
            <input id="text-text" class="input"/>


            <div class="compose-buttons">
                <button type="button" class="btn btn-primary" id="btn-send">Send</button>
                <button type="button" class="btn btn-secondary" id="btn-clear">Clear</button>
            </div>

        </div>
    </div>

    -->


    <script>
        /* Basic debug logging. */
        var log = function (m) {
            console.log(new Date().toISOString() + ' ' + m);
        };


        /* Event notification/subscription implementation. */
        function Event(sender) {
            this._sender = sender;
            this._listeners = [];
            this._contexts = [];
        }

        Event.prototype.attach = function(listener, context=null) {
            this._listeners.push(listener);
            this._contexts.push(context);
        };

        Event.prototype.detach = function(listener) {
            let pos = this._listeners.indexOf(listener);
            if (pos < 0) {
                log('Failed to remove missing listener from event: ' + listener.toString());
                return;
            }

            this._listeners.splice(pos, 1);
            this._contexts.splice(pos, 1);
        };

        Event.prototype.notify = function(event, args) {
            for (let index = 0; index < this._listeners.length; index += 1) {
                this._listeners[index].on_event(this._sender, event, args, this._contexts[index]);
            }
        };


        /* System. */


        /*
        **  Presence Model
        */

        function PresenceModel() {

        }


        /*
        **  Presence View
        */

        function PresenceView(model, parent) {
            this._model = model;
            this._parent = parent;

            this._pane = document.createElement("div");
            this._pane.setAttribute("id", "presence-pane");
            this._pane.setAttribute("class", "presence-pane");

            this._parent.appendChild(this._pane);
        }


        /*
        **  Composer Model
        */

        function ComposerModel() {
            this._event = new Event(this);

            this.clear();
        }

        ComposerModel.prototype.attach = function(listener) {
            this._event.attach(listener);
        };

        ComposerModel.prototype.detach = function(listener) {
            this._event.detach(listener);
        };

        ComposerModel.prototype.get_message = function() {
            let m = {};
            m["Group"] = this._group;
            m["From"] = this._from;
            m["Message"] = this._message;
            m["Timeout"] = this._timeout;

            if (this._in_reply_to !== null) {
                m["In-Reply-To"] = this._in_reply_to;
            }

            return m;
        };

        ComposerModel.prototype.clear = function() {
            this._group = "";
            this._from = "";
            this._message = "";
            this._timeout = 30;
            this._in_reply_to = null;

            this._event.notify('change');
        };

        ComposerModel.prototype.set_group = function(group) {
            this._group = group;
            this._event.notify('change');
        };

        ComposerModel.prototype.set_in_reply_to = function(in_reply_to) {
            this._in_reply_to = in_reply_to;
            this._event.notify('change');
        };

        ComposerModel.prototype.set_from = function(from) {
            this._from = from;
            this._event.notify('change');
        };

        ComposerModel.prototype.set_message = function(message) {
            this._message = message;
            this._event.notify('change');
        };

        ComposerModel.prototype.set_timeout = function(timeout) {
            this._timeout = timeout;
            this._event.notify('change');
        };


        /*
        **  Composer View
        */

        function ComposerView(model, parent) {
            this._model = model;
            this._parent = parent;

            let self = this;

            this._pane = document.createElement("div");
            this._pane.setAttribute("class", "compose-pane");
            this._parent.appendChild(this._pane);

            // Group
            this._group_label = document.createElement("label");
            this._group_label.setAttribute("class", "label group-label");
            this._group_label.setAttribute("for", "group-select");
            this._group_label.innerHTML = "To";
            this._pane.appendChild(this._group_label);

            this._group_select = document.createElement("select");
            this._group_select.setAttribute("id", "group-select");
            this._group_select.setAttribute("class", "input");
            this._group_select.addEventListener('change', function(e) {
                self._model.set_group(e.target.value);
            });
            this._pane.appendChild(this._group_select);

            let options = ["Chat", "elvin", "lunch", "zaphod"];
            let options_count = options.length;
            for (var i = 0; i < options_count; i++) {
                let option = document.createElement("option");
                option.setAttribute("class", "group-option");
                option.setAttribute("value", options[i]);
                option.innerHTML = options[i];
                this._group_select.appendChild(option);
            }

            // From
            this._from_label = document.createElement("label");
            this._from_label.setAttribute("class", "label from-label");
            this._from_label.setAttribute("for", "from-text");
            this._from_label.innerHTML = "From";
            this._pane.appendChild(this._from_label);

            this._from_text = document.createElement("input");
            this._from_text.setAttribute("id", "from-text");
            this._from_text.setAttribute("class", "input");
            this._from_text.addEventListener('change', function(e) {
                self._model.set_from(e.target.value);
            });
            this._pane.appendChild(this._from_text);

            // Timeout
            this._timeout_label = document.createElement("label");
            this._timeout_label.setAttribute("class", "label timeout-label");
            this._timeout_label.setAttribute("for", "timeout-text");
            this._timeout_label.innerHTML = "Timeout";
            this._pane.appendChild(this._timeout_label);

            this._timeout_text = document.createElement("input");
            this._timeout_text.setAttribute("id", "timeout-text");
            this._timeout_text.setAttribute("class", "input");
            this._timeout_text.addEventListener('change', function(e) {
                self._model.set_timeout(e.target.value);
            });
            this._pane.appendChild(this._timeout_text);

            // Text
            this._text_label = document.createElement("label");
            this._text_label.setAttribute("class", "label text-label");
            this._text_label.setAttribute("for", "textt-text");
            this._text_label.innerHTML = "Text";
            this._pane.appendChild(this._text_label);

            this._text_text = document.createElement("input");
            this._text_text.setAttribute("id", "text-text");
            this._text_text.setAttribute("class", "input");
            this._text_text.addEventListener('change', function(e) {
                self._model.set_message(e.target.value);
            });
            this._pane.appendChild(this._text_text);

            // Buttons
            this._compose_buttons = document.createElement("div");
            this._compose_buttons.setAttribute("class", "compose-buttons");
            this._pane.appendChild(this._compose_buttons);

            this._send_button = document.createElement("button");
            this._send_button.setAttribute("type", "button");
            this._send_button.setAttribute("class", "btn btn-primary");
            this._send_button.setAttribute("id", "btn-send");
            this._send_button.innerHTML = "Send";
            this._send_button.addEventListener('click', function(e) {
                controller.send_message();
            });
            this._compose_buttons.append(this._send_button);


            this._clear_button = document.createElement("button");
            this._clear_button.setAttribute("type", "button");
            this._clear_button.setAttribute("class", "btn btn-secondary");
            this._clear_button.setAttribute("id", "btn-clear");
            this._clear_button.innerHTML = "Clear";
            this._clear_button.addEventListener('click', function(e) {
                log("clear");
                self._model.clear();
            });
            this._compose_buttons.append(this._clear_button);

            this._model.attach(this);

        }

        ComposerView.prototype.set_from_model = function() {

            let m = this._model.get_message();

            this._group_select.value = m.Group;
            this._from_text.value = m.From;
            this._timeout_text.value = m.Timeout;
            this._text_text.value = m.Message;
        };

        ComposerView.prototype.on_event = function(sender, event, args) {
            if (event === 'change') {
                this.set_from_model();
            }
        };


        /*
        **  Message Model
        */

        function MessageModel(timestamp, group, from, message, message_id, in_reply_to=null) {
            this._timestamp = timestamp;
            this._group = group;
            this._from = from;
            this._message = message;
            this._message_id = message_id;
            this._in_reply_to = in_reply_to;

            this._parent = null;
            this._replies = [];
        }

        MessageModel.prototype.id = function() {
            return this._message_id;
        };

        MessageModel.prototype.in_reply_to = function() {
            return this._in_reply_to;
        };

        function MessageView(model, parent) {
            this._model = model;
            this._parent = parent;


        }


        /*
        **  History Model
        */

        function HistoryModel() {
            // Message-Id: MossageModel reference
            this._messages = {};
        }

        HistoryModel.prototype.add_message = function(message) {
            // Create message model.
            let m = new MessageModel(message);
            this._messages[m.id()] = m;

            this._event.notify('add', m);
        };


        /*
        **  History View
        */

        function HistoryView(model, parent) {
            this._model = model;
            this._parent = parent;

            this._element = document.createElement("div");
            this._element.setAttribute("class", "history-pane");
            this._parent.appendChild(this._element);
        }


        /*
        **  System Model
        */

        function SystemModel() {
            this._composer = new ComposerModel();
            this._history = new HistoryModel();
            this._presence = new PresenceModel();

            this._groups = [];
            this._username = "";

        }

        SystemModel.prototype.get_username = function() {
            return this._username;
        };

        SystemModel.prototype.get_groups = function() {
            return this._groups;
        };

        SystemModel.prototype.get_history = function() {
            return this._history;
        };

        SystemModel.prototype.get_composer = function() {
            return this._composer;
        };

        SystemModel.prototype.get_presence = function() {
            return this._presence;
        };

        /*
        **  System View
         */

        function SystemView(model, parent) {
            this._model = model;
            this._parent = parent;

            this._content_pane = document.createElement('div');
            this._content_pane.setAttribute("id", "content");
            this._parent.element().appendChild(this._content_pane);

            this._presence_view = new PresenceView(model.get_presence(), this._content_pane);
            this._history_view = new HistoryView(model.get_history(), this._content_pane);
            this._composer_view = new ComposerView(model.get_composer(), this._content_pane);
        }

        SystemView.prototype.element = function() {
            return this._content_pane;
        };


        /*
        **  System Controller
         */

        function SystemController() {
            this._model = new SystemModel();

            var body = document.getElementById("body");
            this._view = new SystemView(this._model, {element: function() {return body; }});

            this._serverUrl = 'ws://127.0.0.1:30030/';
            this._socket = null;
            this._heartbeats = 0;
        }

        SystemController.prototype.model = function() {
            return this._model;
        };

        SystemController.prototype.view = function() {
            return this._view;
        };

        SystemController.prototype.checkHeartbeat = function() {
            if (this._socket == null) {
                // Try to reconnect.
                log("Reconnecting ...");
                this.connect();
                return;
            }

            if (this._heartbeats === 0) {
                log("No heartbeats received from twebo server.");
                this._socket.close();
                this._socket = null;
                return;
            }

            this._heartbeats = 0;
        };

        SystemController.prototype.doLogin = function() {
            log("doLogin");
            var m = '{ "MessageType": "v1.login_request", "RequestId": "1", "UserId": "d", "Password": "d", "Channels": [] }';
            this._socket.send(m);
        };

        SystemController.prototype.handleLogin = function(event) {
            log("handleLogin");
        };

        SystemController.prototype.handleCreateChannel = function(event) {
            log("handleCreateChannel");
        };

        SystemController.prototype.handleModifyChannel = function(event) {
            log("handleModifyChannel");
        };

        SystemController.prototype.handleMessage = function(event) {
            log("handleMessage");
        };

        SystemController.prototype.dispatch = function(m) {
            var msg = JSON.parse(m.data);
            if (!msg.hasOwnProperty("MessageType")) {
                log("Dropping malformed message: " + m.data);
                return;
            }

            log("Message: " + msg.MessageType);
            switch (msg.MessageType) {
                case 'v1.heartbeat':
                    this._heartbeats += 1;
                    break;

                case 'v1.login_response':
                    this.handleLogin(msg);
                    break;

                case 'v1.create_channel_response':
                    this.handleCreateChannel(msg);
                    break;

                case 'v1.modify_channel_response':
                    this.handleModifyChannel(msg);
                    break;

                case 'v1.subscription_response':
                    this.handleSubscription(msg);
                    break;

                case 'v1.message':
                    this.handleMessage(msg);
                    break;

                default:
                    log("Received unhandled message: " + msg.message)
                    break;
            }
        };

        SystemController.prototype.connect = function() {
            var self = this;

            log('Opening server connection: ' + this._serverUrl);
            this._socket = new WebSocket(this._serverUrl);
            this._socket.addEventListener('open', function () {
                log('Server connected.');
                self.doLogin();
            });
            this._socket.addEventListener('message', function (m) {
                self.dispatch(m);
            });
            this._socket.addEventListener('error', function () {
                log('Server connection error.');
            });
            this._socket.addEventListener('close', function() {
                log('Server disconnected.');
            });
        };

        SystemController.prototype.send_message = function() {
            let composer = this._model.get_composer();
            let m = composer.get_message();
            m["MessageType"] = "v1.publish";
            let buf = JSON.stringify(m);
            this._socket.send(buf);
            log("Published: " + buf);
        };

        SystemController.prototype.run = function() {
            var self = this;

            /* Initiate connection to server. */
            this.connect();

            /* Check for heartbeats every 5 seconds. */
            setInterval(function() { self.checkHeartbeat(); }, 5000);
        };


        /* Startup. */
        var controller = new SystemController(parent);
        controller.run();

    </script>
</body>
</html>
